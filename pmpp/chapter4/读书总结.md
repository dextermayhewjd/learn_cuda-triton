# Chapter 4 è®¡ç®—æ¶æ„å’Œè°ƒåº¦

## 4.1 ç°ä»£gpuæ¶æ„

A100 çš„ smæ•°é‡æ˜¯ 108ä¸ªSMæµå¤„ç†å™¨ï¼Œ 

- æ¯ä¸ªsmå•å…ƒæœ‰ 64ä¸ªæ ¸ æ€»å…±6912ä¸ª  
- æ¯ä¸ªSMå•å…ƒæœ‰ 4ä¸ª Tesnor core æ ¸å¿ƒï¼Œ å®Œæ•´gpuå…±432ä¸ªTensor æ ¸å¿ƒ

H100 çš„ smæ•°é‡æ˜¯ 114ä¸ªSMæµå¤„ç†å™¨

- æ¯ä¸ªsmå•å…ƒæœ‰ 128ä¸ªæ ¸ æ€»å…±14592ä¸ª  
- æ¯ä¸ªSMå•å…ƒé…å¤‡4ä¸ªç¬¬å››ä»£Tensoræ ¸å¿ƒï¼Œæ¯ä¸ªå®Œæ•´GPUé…å¤‡456ä¸ªTensoræ ¸å¿ƒ 

Blackwell (GB200 NVL72)

- SM: 8640 (120 Ã— 72)
- Tensor Core: 34,560
- HBM: ~13.8 TB
- å•ä¸€ NVLink è®¡ç®—åŸŸ

## 4.2 å—è°ƒåº¦

- ä¸€ä¸ªå—ä¸­çš„æ‰€æœ‰çº¿ç¨‹éƒ½ä¼šåŒæ—¶åˆ†é…ç»™ä¸€ä¸ªsm
- smæ•°é‡æœ‰é™ï¼Œ åŒæ—¶åˆ†é…ç»™æ¯ä¸ªsmçš„å—æ•°é‡æœ‰é™
- æ’é˜Ÿæœºåˆ¶ä¼šç¡®ä¿ æ–°çš„blockæ‰§è¡Œå®Œæ—¶åˆ†é…æ–°çš„blockç»™SM
- çº¿ç¨‹å› ä¸ºåœ¨ä¸€ä¸ªsmé‡Œ èƒ½ç¡®ä¿çº¿ç¨‹èƒ½å¤Ÿ
  - 1. è®¿é—®å…±äº«å†…å­˜  
  - 2. å±è”½åŒæ­¥  

# 4.3 åŒæ­¥å’Œé€æ˜å¯æ‹“å±•æ€§

- ä¸€ä¸ªå—ä¸­çš„çº¿ç¨‹é€šè¿‡ `_ _ syncthreads( )` (ä¸¤ä¸ª_ ç¬¦å·)  
ç­‰åŒä¸€ä¸ªblock ä¸­æ¯ä¸ªçº¿ç¨‹éƒ½åˆ°è¾¾äº†è¯¥ä½ç½®å†è¿›å…¥ä¸‹ä¸€ä¸ªé˜¶æ®µ

- Barrier synchronization ----- for coordinating parallel activities
  - eg. four people shopping and wait for all to leave  


- __ syncthreads ( )ä½¿ç”¨è§„èŒƒ
  - it must be executed by all threads in a block 
    - cannot be put in a if-else statement , if only one __ syncthreads ( ) is placed since it violate the rule
    å¿…é¡»è¢«æ‰€æœ‰ä¸€ä¸ªblockçš„æ‰€æœ‰çº¿ç¨‹æ‰§è¡Œ ä¸èƒ½åœ¨if æˆ–è€…elseçš„å•ä¸ªä¸­æ‰§è¡Œ å¦åˆ™ä¼šæ­»é”

- cuda runtime systemå¯ä»¥ä»¥ä»»ä½•ç›¸å¯¹é¡ºåºæ‰§è¡Œå—
 å› ä¸ºå—ä¹‹é—´æ²¡æœ‰åŒæ­¥çº¦æŸ

## 4.4 çº¿ç¨‹æŸ warp å’ŒSIMD ç¡¬ä»¶

### 4.4.1 warpçš„åŸºæœ¬åˆ†é…ç­–ç•¥

- ä¸€æ—¦ä¸€ä¸ªå—è¢«åˆ†é…ç»™SMï¼Œå°±ä¼šè¢«è¿›ä¸€æ­¥åˆ’åˆ†ä¸º32ä¸ªçº¿ç¨‹å•å…ƒ ç§°ä¹‹ä¸ºçº¿ç¨‹æŸwarp
- ç›®å‰çº¿ç¨‹æŸéƒ½æ˜¯32ä¸ªçº¿ç¨‹

- å¦‚æœä¸€ä¸ªblockæ˜¯è¢«ç»„ç»‡æˆä¸€ç»´çš„æ•°ç»„ï¼Œé‚£ä¹ˆwarpä» threadidx.x = 0 å¼€å§‹
åˆ°31ç»“æŸ
  - å¦‚æœæ˜¯32çš„å€æ•°ï¼Œé‚£ä¹ˆè¢«åˆ†æˆä¸ª
  - å¦‚æœä¸æ˜¯ ä½™æ•°ä¼šè¢«åˆ’åˆ†ä¸ºå¦ä¸€ä¸ªwarp

- å¦‚æœæ˜¯å¤šç»´æ•°ç»„ï¼Œä¼šå…ˆçº¿æ€§æŠ•å½±åˆ°çº¿æ€§å¸ƒå±€ï¼Œ xä»å°åˆ°å¤§ï¼Œç„¶åå†æ˜¯y
![alt text](5277a6b16763aa119a6e5463f2839c6.png)
### 4.4.2 SIMDå’Œ warp

- åœ¨ä»»æ„æ—¶åˆ»ï¼Œä¸ºwarpçš„æ‰€æœ‰threadç»™æå–å¹¶æ‰§è¡Œä¸€æ¡æŒ‡ä»¤
- a100 çš„ sm é‡Œ64ä¸ªæ ¸å¿ƒï¼Œ è¢«åˆ†æˆäº†4ä¸ªprocessing block,æ¯ä¸ªå¤„ç†å— æœ‰16ä¸ªæ ¸å¿ƒ
- åŒä¸€ä¸ªwarp çš„threadè¢«åˆ†é…åˆ°ä¸€ä¸ªprocessing block.
- åŒä¸€ä¸ªprocessing blockä¸ºwarpä¸­æ‰€æœ‰thread 
  è·å– å¹¶ä¸”æ‰§è¡Œ è¿™äº›æŒ‡ä»¤instruction
- ç”±äºè¿™äº›çº¿ç¨‹å¯¹æ•°æ®çš„ä¸åŒéƒ¨åˆ†æ‰§è¡Œäº†ç›¸åŒçš„æŒ‡ä»¤ï¼Œè¢«ç§°ä¹‹ä¸ºSIMD

## 4.5 æ§åˆ¶å‘æ•£

å°‘å†™if else 
å¦åˆ™è¦åˆ†è·¯å¾„æ‰§è¡Œ
 ![alt text](2920b54278a390f66b930b5f79affff.png)

å¦‚æœåŒä¸€ä¸ªwarpå†… æ‰€æœ‰çº¿ç¨‹å¿…é¡»éƒ½å®ŒæˆæŸä¸ªé˜¶æ®µ
é‚£ä¹ˆå¿…é¡»è¦ä¾é  __ syncwarp() __ æ¥ä¿è¯æ­£ç¡®æ€§

## 4.6 Warp scheduling and latency tolerance


### 4.6.1 ä»€ä¹ˆæ˜¯latency tolerance / hiding

1. warp A è§¦å‘ä¸€ä¸ª global memory loadï¼ˆå¾ˆæ…¢ï¼‰
2. warp A è¢«æ ‡è®°ä¸ºâ€œç­‰å¾…â€
3. SM çš„ warp scheduler é€‰æ‹© warp B æ¥æ‰§è¡Œ
4. å½“ warp B ä¹Ÿé‡åˆ°å»¶è¿Ÿ â†’ é€‰ warp Cï¼Œä¾æ­¤ç±»æ¨

æ˜¯warpæ‰§è¡Œåˆ°éœ€è¦ç­‰å¾…å¯åŠ¨çš„é•¿å»¶è¿Ÿæ“ä½œï¼Œ è¿™ç§æ“ä½œç§°ä¹‹ä¸ºlatency tolerance
ä¸ºäº†è®©smè®¡ç®—å•å…ƒæ°¸è¿œæœ‰å¯ä»¥è®¡ç®—çš„warpä¸ä¼š å‡ºç°sm ç©ºç­‰å†…å­˜çš„æƒ…å†µ

### 4.6.2 warp scheduling è¿˜ç”¨äºå…¶ä»–ç±»å‹çš„æ“ä½œå»¶è¿Ÿ

- pipelined floating-point arithmetic æµæ°´çº¿æµ®ç‚¹è¿ç®—
- branch instructions åˆ†æ”¯æŒ‡ä»¤

é€‰æ‹©å‡†å¤‡æ‰§è¡Œçš„warp ä¸ä¼šåœ¨æ‰§è¡Œæ—¶é—´çº¿ä¸­å¼•å…¥ä»»ä½•ç©ºé—² æˆ– æµªè´¹æ—¶é—´

### 4.6.3 ç¡¬ä»¶ä¸Šé¢çš„è®¾è®¡ ä¸åŒæ¶æ„

ä¸ºäº†è®©latency tolerance å®ç°ï¼Œæœ€å¥½ä¸ºsmå•å…ƒåˆ†é… æ¯”èµ·æ‰§è¡Œèµ„æºæ›´å¤šçš„çº¿ç¨‹

ä¸€ä¸ªSM é€šå¸¸è¢«åˆ†é…éå¸¸å¤šçº¿ç¨‹

- ä¸€ä¸ª SM å¯èƒ½åªæœ‰ 64 æˆ– 128 ä¸ª FP32 cores  
- ä½† SM ä¸Šå¸¸é©»çš„çº¿ç¨‹å¯èƒ½æ˜¯ 2048 ä¸ª  


æ—§æ¶æ„ï¼š
- ä¸€ä¸ª SM = ä¸€ä¸ª warp åŒæ—¶æ‰§è¡Œ â†’ æ¯”å¦‚ 32 çº¿ç¨‹ lockstep æ‰§è¡ŒåŒä¸€æ¡æŒ‡ä»¤

æ–°æ¶æ„ï¼š
- ä¸€ä¸ª SM å¯ä»¥å¹¶è¡Œè°ƒåº¦å¤šä¸ª warp
- ä¾‹å¦‚ Ampere å¯ä»¥ dual-issueï¼Œç”šè‡³åŒæ—¶æ¥è‡ªä¸åŒ warp çš„æŒ‡ä»¤

`è¶…é¢è®¢é˜…` oversubscription 

## **GPU é«˜ååé‡ = zero-overhead scheduling + oversubscription**


> **GPU é€šè¿‡è®©æ¯ä¸ª warp çš„å®Œæ•´æ‰§è¡ŒçŠ¶æ€å¸¸é©»äº SM å¯„å­˜å™¨ï¼Œä»è€Œå®ç°é›¶å¼€é”€ warp åˆ‡æ¢ï¼Œå¹¶ä¾é å¤§é‡æ´»è·ƒ warps çš„ oversubscription æ¥éšè—æ‰€æœ‰é•¿å»¶è¿Ÿï¼ˆmemoryã€branchã€pipelineï¼‰æ“ä½œï¼Œä»è€Œç»´æŒé«˜ååé‡ã€‚**

## 4.7 Resource partitioning and occupancy p85

### 4.7.1 occupancyå ç”¨ç‡

- the ratio of the number warps assigned to an SM
- to the maximum number it supports 
- Occupancy =ï¼ˆå®é™…å¯åœ¨ SM ä¸Šè¿è¡Œçš„ warps æ•°ï¼‰/ï¼ˆSM å…è®¸çš„æœ€å¤§ warps æ•°ï¼‰

### 4.7.2 æ‰§è¡Œèµ„æºå’Œè·¨çº¿ç¨‹åŠ¨æ€åˆ†é…

smçš„æ‰§è¡Œèµ„æºåŒ…æ‹¬ï¼š  

- å¯„å­˜å™¨ register
- å…±äº«å†…å­˜ shared memory
- çº¿ç¨‹æ§½ thread slot
- çº¿ç¨‹å—æ§½ thread block slot

A100 / H100 / B200 / 3090 / 5090 å…¨éƒ¨ä¸€è‡´

| èµ„æº                  | æ•°å€¼       | è¯´æ˜                |
| ------------------- | -------- | ----------------- |
| **æœ€å¤§ blocks / SM**  | **32**   | ç†è®ºä¸Šé™              |
| **æœ€å¤§ threads / SM** | **2048** | = 64 warps        |
| **æœ€å¤§ warps / SM**   | **64**   | warp = 32 threads |
| **warp size**       | **32**   | æ°¸ä¹…ä¸å˜              |


å„ä¸ªèµ„æºä¹‹é—´ä¼šæœ‰åˆ¶çº¦å…³ç³»

#### `4.7.2.1 å¦‚æœblockå¤ªå° blockæ§½ä¸å¤Ÿç”¨`

##### ä¾‹å­ï¼šblock = 32 threads

ç†è®ºä¸Šï¼ˆ2048/32 = 64 blocksï¼‰ï¼Œä½†æ˜¯ï¼š

- ä¸€ä¸ª SM åªèƒ½åŒæ—¶æ”¯æŒ **æœ€å¤š 32 blocks**

- æ‰€ä»¥åªèƒ½å¼€å‡º **32 blocks Ã— 32 threads = 1024 threads**

â†’ çº¿ç¨‹æ§½åªç”¨äº† 1024/2048 = **50% occupancy**

ğŸ’¡ ç»“è®ºï¼š  
**block å¤ªå°ï¼Œä¼šè¢« block æ•°é™åˆ¶ä½ï¼Œä»è€Œæ— æ³•å¡«æ»¡çº¿ç¨‹æ§½**


#### `4.7.2.2 block å¤§å°ä¸æ˜¯ 2048 çš„å› æ•°æ—¶ä¹Ÿä¼šæŸå¤± occupancy`

ä¾‹å¦‚ block = **768 threads**

- 2048 / 768 = 2.66 â†’ åªèƒ½æ”¾ **2 blocks**

- 2 blocks = **1536 threads**

- å‰©ä½™ 512 thread slots å¿…ç„¶æµªè´¹æ‰

â†’ occupancy = 1536 / 2048 = **75%**


#### `4.7.2.3 å¯„å­˜å™¨ä¹Ÿä¼šé™åˆ¶ occupancy`

A100 æœ‰ï¼š

- **65536 registers / SM**
    

è¦è¾¾åˆ°æ»¡ occupancyï¼š

- 2048 threads å¹³å‡èƒ½ç”¨çš„å¯„å­˜å™¨æ•°ä¸º  
    65536 / 2048 = **32 registers per thread**
    

##### Example 1ï¼šä½¿ç”¨ 31 registersï¼ˆOKï¼‰

- 2048 threads Ã— 31 = 63488ï¼ˆ<65536ï¼‰
    
- occupancy = **100%**
    

##### Example 2ï¼šä½¿ç”¨ 33 registersï¼ˆä¸å¤Ÿç”¨ï¼ï¼‰

- 2048 Ã— 33 = 67584ï¼ˆ>65536ï¼‰
    
- æ— æ³•åŒæ—¶è¿è¡Œ 2048 threads â†’ ç³»ç»Ÿå‡å°‘ blocks æ•°
    

å¯èƒ½å˜æˆï¼š

- 3 blocks Ã— 512 threads = 1536 threads  
    å¯„å­˜å™¨éœ€æ±‚ï¼š1536Ã—33 = 50688ï¼ˆå¯ä»¥ï¼‰
    

â†’ occupancy = 1536/2048 = **75%**

ğŸ¯ **ä»…ä»…å¤šå®šä¹‰ä¸¤ä¸ªè‡ªåŠ¨å˜é‡ï¼ˆå¤šç”¨ 2 ä¸ªå¯„å­˜å™¨ï¼‰ï¼Œoccupancy ä» 100% æ‰åˆ° 75% â†’ è¿™å°±æ˜¯æ€§èƒ½æ‚¬å´–ï¼ˆperformance cliffï¼‰ã€‚**


### 4.8 æŸ¥è¯¢è®¾å¤‡å±æ€§

# ğŸš€ ç”¨äºæŸ¥è¯¢å±æ€§çš„ CUDA è¿è¡Œæ—¶å‡½æ•°

## 1. **cudaGetDeviceCount(int* count)**

è¿”å›æœ‰å¤šå°‘å°æ”¯æŒ CUDA çš„è®¾å¤‡å¯ç”¨ã€‚

ä¾‹å­ï¼š

```c++
int devCount; cudaGetDeviceCount(&devCount);
```
## 2. **cudaGetDeviceProperties(cudaDeviceProp* prop, int deviceId)**

`cudaDeviceProp`ç”¨è®¾å¤‡çš„è¯¦ç»†ä¿¡æ¯å¡«å……ç»“æ„ä½“ã€‚

ä¾‹å­ï¼š

```c++
cudaDeviceProp devProp; for (int i = 0; i < devCount; i++) {     cudaGetDeviceProperties(&devProp, i);     // Use devProp fields here }
```

## **3. cudaDeviceProp ç»“æ„ä½“ä¸­å¸¸ç”¨çš„å…³é”®å­—æ®µ**

### **(1) maxThreadsPerBlock**

- æ¯ä¸ª Block æœ€å¤šå¯å®¹çº³çš„çº¿ç¨‹æ•°ã€‚
    
- å¸¸è§è®¾å¤‡ä¸º 1024ï¼Œä½†ä¸åŒæ¶æ„å¯èƒ½æ›´ä½æˆ–æ›´é«˜ã€‚
    
- ç¨‹åºåº”é€šè¿‡æ­¤å­—æ®µè‡ªåŠ¨é€‰æ‹©åˆé€‚çš„ block å¤§å°ï¼Œè€Œä¸æ˜¯å†™æ­»ä¸º 1024ã€‚
    

---

### **(2) multiProcessorCount**

- SM çš„æ•°é‡ã€‚
    
- SM è¶Šå¤šï¼Œå³°å€¼ååèƒ½åŠ›è¶Šé«˜ï¼Œé€‚åˆéœ€è¦å¤§é‡å¹¶è¡Œè®¡ç®—çš„åº”ç”¨ã€‚
    

---

### **(3) clockRate**

- GPU çš„æ—¶é’Ÿé¢‘ç‡ã€‚
    
- ä¸ SM æ•°é‡ç»“åˆå¯ä¼°ç®—æœ€å¤§ç¡¬ä»¶æ‰§è¡Œèƒ½åŠ›ã€‚
    

---

### **(4) maxThreadsDim[]**

æ¯ä¸ª Block ç»´åº¦çš„æœ€å¤§çº¿ç¨‹æ•°ï¼š

- `maxThreadsDim[0]`: x æ–¹å‘æœ€å¤§çº¿ç¨‹æ•°
    
- `maxThreadsDim[1]`: y æ–¹å‘æœ€å¤§çº¿ç¨‹æ•°
    
- `maxThreadsDim[2]`: z æ–¹å‘æœ€å¤§çº¿ç¨‹æ•°
    

ç”¨äºè‡ªåŠ¨è°ƒä¼˜ï¼ˆAuto-tuningï¼‰å¯»æ‰¾æœ€ä½³ block å°ºå¯¸ã€‚

---

### **(5) maxGridSize[]**

Grid åœ¨æ¯ä¸ªç»´åº¦ä¸Šçš„æœ€å¤§ block æ•°ï¼š

- `maxGridSize[0]`: x æ–¹å‘æœ€å¤§ block æ•°
    
- `maxGridSize[1]`: y æ–¹å‘æœ€å¤§ block æ•°
    
- `maxGridSize[2]`: z æ–¹å‘æœ€å¤§ block æ•°
    

å¯ç”¨äºåˆ¤æ–­æ•°æ®è§„æ¨¡æ˜¯å¦èƒ½ä¸€æ¬¡æ€§è¦†ç›–ï¼Œå¦åˆ™éœ€è¦è¿­ä»£å¤„ç†ã€‚

---

### **(6) regsPerBlock**

- æ¯ä¸ª SM å¯ç”¨çš„å¯„å­˜å™¨æ•°é‡ã€‚
    
- ä¸å†…æ ¸ï¼ˆkernelï¼‰çš„å¯„å­˜å™¨ä½¿ç”¨é‡å…±åŒå†³å®š **occupancyï¼ˆå ç”¨ç‡ï¼‰**ã€‚
    
- æ³¨æ„ï¼šåœ¨æŸäº›è®¡ç®—èƒ½åŠ›ä¸­ï¼Œblock å¯ç”¨å¯„å­˜å™¨ â‰  SM æ€»å¯„å­˜å™¨ã€‚
    

---

### **(7) warpSize**

- Warp çš„å¤§å°ï¼ˆé€šå¸¸ä¸º 32ï¼‰ã€‚
    
- ä¸åŒæ¶æ„å¯èƒ½å˜åŒ–ï¼Œå› æ­¤ä¸åº”å†™æ­»ã€‚
    

---

## **4. å…¶ä»–å­—æ®µ**

`cudaDeviceProp` ä¸­è¿˜æœ‰è®¸å¤šå…¶ä»–å­—æ®µï¼Œç”¨äºåæ˜ è®¾å¤‡çš„å„ç±»ç¡¬ä»¶ç‰¹æ€§ï¼Œå®ƒä»¬ä¼šåœ¨å­¦ä¹  CUDA å„ç« èŠ‚æ—¶é€æ­¥æ¶‰åŠã€‚